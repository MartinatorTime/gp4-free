# Use Python slim image for smaller size
FROM python:3.11-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    G4F_PROXY="" \
    G4F_COOKIES_PATH="/root/.config/g4f/cookies/.env" \
    NO_SANDBOX=1

# Install system dependencies and clean up in one layer
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    ffmpeg \
    chromium \
    && pip install --no-cache-dir --upgrade pip \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Clone repo and install dependencies in one layer
RUN git clone --depth 1 https://github.com/xtekky/gpt4free.git . && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir -e . && \
    apt-get purge -y --auto-remove git && \
    rm -rf .git /var/lib/apt/lists/*

# Ensure the cookies directory exists
RUN mkdir -p /root/.config/g4f/cookies/

#  Expose the API port
EXPOSE 8080

CMD ["python3", "g4f_cli.py", "api", "-d", "-p", "8080", "-ng", "--timeout", "60", "--ignored-providers", "PuterJS", "Azure", "BingCreateImages", "MetaAIAccount", "CopilotAccount", "Gemini", "GeminiCLI", "GeminiPro", "HuggingFace", "HuggingFaceMedia", "HuggingFaceAPI", "LMArena", "Groq", "MetaAI", "MicrosoftDesigner", "OpenaiAccount", "OpenaiChat", "OpenRouter"]